<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Empresario Registration Form</title>
    <style>
      body {
        margin: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        color: #fafafa;
        background:
          radial-gradient(
            ellipse 70% 55% at 50% 30%,
            #24243a 20%,
            #191924 75%,
            #12121a 100%
          ),
          repeating-linear-gradient(
            135deg,
            #232335 0px,
            #232335 2px,
            transparent 2px,
            transparent 32px
          ),
          repeating-linear-gradient(
            45deg,
            #1b1b27 0px,
            #1b1b27 2px,
            transparent 2px,
            transparent 32px
          ),
          #15151d;
        background-blend-mode: lighten;
        background-size: cover, 44px 44px, 44px 44px, auto;
        transition: background 0.4s;
        overflow-x: hidden;
        position: relative;
      }

      #email::placeholder {
        color: rgba(1, 10, 22, 0.6);
        font-style: italic;
        transition: color 0.3s ease;
      }

      #email:focus::placeholder {
        color: rgba(255, 255, 255, 0.3);
      }

      @keyframes gradientShift {
        0% {
          background-position: 0% 50%;
        }

        50% {
          background-position: 100% 50%;
        }

        100% {
          background-position: 0% 50%;
        }
      }

      .particles {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
      }

      .particle {
        position: absolute;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
      }

      @keyframes float {
        0%,
        100% {
          transform: translateY(0px) rotate(0deg);
          opacity: 0.3;
        }

        50% {
          transform: translateY(-20px) rotate(180deg);
          opacity: 0.8;
        }
      }

      .container {
        max-width: 1000px;
        margin: 30px auto;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        z-index: 2;
        animation: containerGlow 3s ease-in-out infinite alternate;
      }

      @keyframes containerGlow {
        0% {
          box-shadow: 0 0 30px rgba(255, 255, 255, 0.1);
        }

        100% {
          box-shadow: 0 0 50px rgba(255, 255, 255, 0.2);
        }
      }

      .stepper {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 40px;
        gap: 0px;
      }

      .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
        position: relative;
        min-width: 0;
      }

      .step:not(:last-child)::after {
        content: "";
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
  left: calc(100% + 23px);
  width: calc(100% - 46px);
        height: 2px;
        background: linear-gradient(90deg, #444750, #23232d 90%);
        z-index: 1;
      }

      .step.active:not(:last-child)::after {
        background: linear-gradient(90deg, #b2b9c9 0%, #23232d 90%);
      }

      @media (max-width: 700px) {
        .step:not(:last-child)::after {
          width: calc(100% - 36px);
          height: 2px;
          left: 50%;
          transform: translateY(-50%);
        }
      }

      .step-circle {
        width: 46px;
        height: 46px;
        border-radius: 50%;
        background: linear-gradient(145deg, #2c2c37, #353540);
        color: #f0f0f0;
        font-size: 22px;
        font-weight: 700;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #51515f;
        margin-bottom: 7px;
        box-shadow: 0 2px 8px #23232a18;
        transition: background 0.25s, border 0.25s, color 0.25s;
        z-index: 2;
      }

      .step.active .step-circle {
        background: #e6e6e9;
        color: #22242c;
        border-color: #b9b9ca;
        font-weight: 800;
        box-shadow: 0 0 0 4px #e6e6e940;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
        }

        50% {
          transform: scale(1.05);
        }

        100% {
          transform: scale(1);
        }
      }

      .step-title {
        font-size: 13px;
        color: #b7b7be;
        text-align: center;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 0;
        margin-bottom: 0;
        transition: color 0.25s;
        user-select: none;
      }

      .step.active .step-title {
        color: #fff;
      }

      .step:not(:last-child)::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 100%;
        height: 2.5px;
        width: 100%;
        background: linear-gradient(90deg, #444750, #23232d 90%);
        z-index: 1;
        transform: translateY(-50%);
      }

      .step.active:not(:last-child)::after {
        background: linear-gradient(90deg, #b2b9c9 0%, #23232d 90%);
      }

      @media (max-width: 700px) {
        .step:not(:last-child)::after {
          width: 100%;
          height: 2px;
        }
      }

      .step-title {
        font-size: 11.5px;
        letter-spacing: 0.7px;
      }

      .step:not(:last-child)::after {
        height: 2px;
        width: calc(100% - 36px);
      }

      .form-section {
        margin-top: 30px;
      }

      label {
        display: block;
        margin-bottom: 6px;
        font-weight: bold;
        transition: color 0.3s ease;
      }

      label:hover {
        color: #fff;
      }

      input,
      select,
      textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 20px;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        background: rgba(255, 255, 255, 0.05);
        color: white;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: #fff;
        box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        background: rgba(255, 255, 255, 0.1);
      }

      input::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      textarea {
        resize: vertical;
      }

      .button,
      .otp-btn {
        background: linear-gradient(135deg, #444c5c, #2b2f3a);
        color: #f0f0f0;
        padding: 12px 22px;
        font-size: 15px;
        font-weight: 600;
        border: 1.5px solid #505769;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
        flex-shrink: 0;
        user-select: none;
        position: relative;
        overflow: hidden;
        outline-offset: 2px;
        transform: translateY(0);
      }

      .otp-btn:hover,
      .otp-btn:focus,
      .button:hover,
      .button:focus {
        background: linear-gradient(135deg, #5a6280, #3a3f57);
        border-color: #7383b5;
        color: #ffffff;
        box-shadow: 0 4px 15px #7383b5a0;
        outline: none;
        transform: translateY(-2px);
      }

      .otp-btn:active,
      .button:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        transition: all 0.1s ease;
      }

      @media (max-width: 700px) {
        .otp-btn {
          min-width: 100%;
          padding: 12px 0;
          font-size: 16px;
        }
      }

      .row {
        display: flex;
        gap: 20px;
      }

      .row > div {
        flex: 1;
      }

      .email-row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        align-items: center;
      }

      .email-row input[type="email"] {
        flex: 1;
        background: rgba(255, 255, 255, 0.9);
        color: #000;
        margin-bottom: 0;
      }

      .email-row .otp-btn {
        margin-bottom: 0;
        min-width: 140px;
      }

      .next-btn {
        background: linear-gradient(135deg, #444c5c, #2b2f3a);
        color: #f0f0f0;
        padding: 12px 22px;
        font-size: 15px;
        font-weight: 600;
        border: 1.5px solid #505769;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
        flex-shrink: 0;
        user-select: none;
        position: relative;
        overflow: hidden;
        outline-offset: 2px;
        margin-left: 8px;
        transform: translateY(0);
      }

      .next-btn:hover,
      .next-btn:focus {
        background: linear-gradient(135deg, #5a6280, #3a3f57);
        border-color: #7383b5;
        color: #ffffff;
        box-shadow: 0 4px 15px #7383b5a0;
        outline: none;
        transform: translateY(-2px);
      }

      .next-btn:active {
        transform: translateY(0);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        transition: all 0.1s ease;
      }

      .next-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: translateY(0);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
      }

      .next-btn:disabled:hover {
        transform: translateY(0);
        background: linear-gradient(135deg, #444c5c, #2b2f3a);
        border-color: #505769;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.35);
      }

      @media (max-width: 700px) {
        .next-btn {
          min-width: 100%;
          padding: 12px 0;
          font-size: 16px;
        }
      }

      .required {
        color: #ff6b6b;
        margin-left: 2px;
        animation: blink 2s infinite;
      }

      @keyframes blink {
        0%,
        50% {
          opacity: 1;
        }

        51%,
        100% {
          opacity: 0.5;
        }
      }

      .section-title {
        font-size: 20px;
        color: #fff;
        margin-top: 40px;
        margin-bottom: 28px;
        border-bottom: 2px solid #fff;
        padding-bottom: 10px;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      }

      @media (max-width: 700px) {
        .container {
          padding: 10px;
        }

        .stepper {
          flex-direction: column;
          gap: 16px;
        }

        .email-row {
          flex-direction: column;
          gap: 20px;
          align-items: center;
        }
      }

      .error-message {
        color: #ff6b6b;
        font-size: 14px;
        margin-bottom: 10px;
        display: none;
      }

      .success-message {
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        font-size: 18px;
        font-weight: bold;
        margin: 20px 0;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        border: 2px solid rgba(76, 175, 80, 0.5);
        display: none;
        animation: slideIn 0.5s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .hidden {
        display: none;
      }

      .form-step {
        opacity: 1;
        transform: translateX(0);
        transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        position: relative;
      }

      .form-step.fade-out {
        opacity: 0;
        transform: translateX(-30px);
      }

      .form-step.fade-in {
        opacity: 0;
        transform: translateX(30px);
        animation: slideInRight 0.6s ease-out forwards;
      }

      @keyframes slideInRight {
        from {
          opacity: 0;
          transform: translateX(30px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }

      @keyframes slideOutLeft {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(-30px);
        }
      }

      .step {
        transition: all 0.3s ease-in-out;
      }

      .step-circle {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .step.active .step-circle {
        animation: pulse 0.6s ease-in-out;
      }

      select {
        background: rgba(255, 255, 255, 0.05);
        color: #fff;
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: border 0.3s, background 0.3s;
      }

      select:focus {
        border-color: #fff;
        background: rgba(255, 255, 255, 0.12);
        outline: none;
      }

      select option {
        background: #222;
        color: #fff;
      }

      select option:hover,
      select option:focus {
        background: #fff;
        color: #000;
      }

      @-moz-document url-prefix() {
        select option:hover,
        select option:focus {
          background: #fff !important;
          color: #000 !important;
        }
      }

      .reg-banner {
        width: 98vw;
        background: linear-gradient(
          100deg,
          #28243e 0%,
          #232526 55%,
          #4b23a0 100%
        );
        color: #ffffff;
        padding: 40px 16px 28px 16px;
        text-align: center;
        margin-bottom: 22px;
        border-bottom: 2.5px solid #7f52ff90;
        border-radius: 0 0 22px 22px;
        position: relative;
        box-shadow: 0 8px 32px 0 #1c174920, 0 2px 36px 0 #7f52ff33;
        z-index: 3;
        overflow: hidden;
      }

      .reg-banner::after {
        content: "";
        position: absolute;
        inset: 0;
        background: radial-gradient(
          circle at 60% 30%,
          #7f52ff33 0%,
          transparent 70%
        );
        z-index: 1;
        pointer-events: none;
        opacity: 0.66;
      }

      .reg-banner h1 {
        font-size: 2.35rem;
        margin-bottom: 10px;
        margin-top: 0;
        letter-spacing: 1.5px;
        font-weight: 800;
        background: linear-gradient(
          90deg,
          #a996ff 30%,
          #fffbe8 65%,
          #8f5cfa 100%
        );
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .reg-banner p {
        font-size: 1.22rem;
        margin: 0;
        font-weight: 500;
        color: #c7bfff;
        text-shadow: 0 1px 10px #4b23a055;
      }

      @media (max-width: 700px) {
        .reg-banner {
          padding: 20px 8px 12px 8px;
          border-radius: 0 0 10px 10px;
          margin-bottom: 12px;
        }

        .reg-banner h1 {
          font-size: 1.18rem;
        }

        .reg-banner p {
          font-size: 0.97rem;
        }
      }
    </style>
  </head>

  <body>
    <div class="particles" id="particles"></div>
    <div class="reg-banner">
      <h1>Empresario Startup Registration 2025</h1>
    </div>

    <div class="container">
      <div class="stepper">
        <div class="step active" id="step-1-indicator">
          <div class="step-circle">1</div>
          <div class="step-title">EMAIL VERIFICATION</div>
        </div>
        <div class="step" id="step-2-indicator">
          <div class="step-circle">2</div>
          <div class="step-title">PERSONAL INFORMATION</div>
        </div>
        <div class="step" id="step-3-indicator">
          <div class="step-circle">3</div>
          <div class="step-title">STARTUP INFORMATION</div>
        </div>
        <div class="step" id="step-4-indicator">
          <div class="step-circle">4</div>
          <div class="step-title">BUSINESS OVERVIEW</div>
        </div>
      </div>
      <!-- Step 1: Email Verification -->
      <form id="regForm" novalidate>
        <div id="step-1" class="form-step">
          <label>Email ID <span class="required">*</span></label>
          <div class="email-row">
            <input
              type="email"
              id="email"
              required
              placeholder="Enter your email"
            />
            <button type="button" class="otp-btn" id="sendOtpBtn">
              Send OTP
            </button>
          </div>
          <div id="email-error" class="error-message">
            Please enter a valid email address.
          </div>
          <div id="otp-section" class="hidden">
            <label>Enter OTP <span class="required">*</span></label>
            <input type="text" id="otp" maxlength="6" placeholder="Enter OTP" required />
            <div id="otp-error" class="error-message">
              Please enter the OTP sent to your email.
            </div>
            <label>New Password <span class="required">*</span></label>
            <input type="password" id="password" placeholder="New Password" required />
            <label>Confirm Password <span class="required">*</span></label>
            <input
              type="password"
              id="confirmPassword"
              placeholder="Confirm Password"
              required
            />
            <div id="password-error" class="error-message">
              Passwords do not match.
            </div>
          </div>
          <button type="button" class="next-btn" id="nextBtn" disabled>
            Next
          </button>
        </div>
        <!-- Step 2: Personal Information -->
        <div id="step-2" class="form-step" style="display: none">
          <div class="form-section">
            <div class="section-title">Founder & Team Details</div>
            <label>Full Name (Team Leader)</label>
            <input type="text" required />
            <label>Email Address</label>
            <input type="email" required />
            <label>Phone Number</label>
            <input type="tel" required/>
            <label>College/Organization</label>
            <input type="text" required />
            <label>City</label>
            <input type="text" required />
          </div>
          <button type="button" class="next-btn" onclick="handleStep2Next()">
            Next
          </button>
        </div>
        <!-- Step 3: Startup Information -->
        <div id="step-3" class="form-step" style="display: none">
          <div class="form-section">
            <div class="section-title">Startup Details</div>
            <label>Startup Name</label>
            <input type="text" required/>
            <label>Website (if any)</label>
            <input type="url" placeholder="https://www.example.com" required />
            <label>Industry/Domain</label>
            <select required>
              <option value="" disabled selected>Select One</option>
              <option>E-Commerce</option>
              <option>Enterprisetech</option>
              <option>Fintech</option>
              <option>Deeptech</option>
              <option>Cleantech</option>
              <option>Healthtech</option>
              <option>Agritech</option>
              <option>AI and ML</option>
              <option>Climate and Sustainability</option>
              <option>Spacetech</option>
              <option>Logistics</option>
              <option>Edtech</option>
              <option>Media and Entertainment</option>
              <option>Consumer Services</option>
              <option>Web3 and Blockchain</option>
              <option>Others</option>
            </select>
            <label
              >Does your startup aim to solve a social or community
              problem?</label
            >
            <select required>
              <option value="" disabled selected>Select One</option>
              <option>Yes</option>
              <option>No</option>
            </select>
            <label
              >Is your team founded by IIT Kharagpur students, alumni, or
              faculty?</label
            >
            <select required>
              <option value="" disabled selected>Select One</option>
              <option>Yes</option>
              <option>No</option>
            </select>
            <label>Is AI/ML a core part of your product or tech stack?</label>
            <select required>
              <option value="" disabled selected>Select One</option>
              <option>Yes</option>
              <option>No</option>
            </select>
            <label>Where did you hear about Empresario?</label>
            <input type="text" required/>
          </div>
          <button type="button" class="next-btn" onclick="handleStep3Next()">
            Next
          </button>
        </div>
        <!-- Step 4: Business Overview -->
        <div id="step-4" class="form-step" style="display: none">
          <div class="form-section">
            <div class="section-title">Business Overview</div>
            <label>What problem are you solving?</label>
            <textarea rows="3" required></textarea>
            <label>What is your proposed solution?</label>
            <textarea rows="3" required></textarea>
            <label>Target market and estimated size</label>
            <textarea rows="3" required></textarea>
            <label>Traction so far (if any)</label>
            <textarea rows="3" required></textarea>
            <label>Revenue model</label>
            <textarea rows="3" required></textarea>
            <label>Anything else you'd like to share? (Optional)</label>
            <textarea rows="3"></textarea>
          </div>
          <button id="submitBtn" class="button" type="submit">Submit</button>
          <div id="success-message" class="success-message">
            🎉 Congratulations! You are successfully registered for Empresario Startup Registration 2025! 🎉
          </div>
        </div>
      </form>
    </div>
    <script>
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbydeSUhxPmlH-OLsZW1yBUszPndmJ1UgNXEQhR0s-Q0uh5iRqseh-dTyIS8os5MkAkcbQ/exec";

      function createParticles() {
        const particlesContainer = document.getElementById("particles");
        const particleCount = 50;

        for (let i = 0; i < particleCount; i++) {
          const particle = document.createElement("div");
          particle.className = "particle";

          const size = Math.random() * 4 + 2;
          particle.style.width = size + "px";
          particle.style.height = size + "px";
          particle.style.left = Math.random() * 100 + "%";
          particle.style.top = Math.random() * 100 + "%";
          particle.style.animationDelay = Math.random() * 6 + "s";
          particle.style.animationDuration = Math.random() * 3 + 3 + "s";
          particlesContainer.appendChild(particle);
        }
      }

      createParticles();

      function nextStep(step) {
        let currentStep = null;
        for (let i = 1; i <= 4; i++) {
          const stepElement = document.getElementById("step-" + i);
          if (stepElement.style.display !== "none") {
            currentStep = i;
            break;
          }
        }

        if (currentStep && currentStep !== step) {
          const currentStepElement = document.getElementById("step-" + currentStep);
          currentStepElement.classList.add("fade-out");
          setTimeout(() => {
            for (let i = 1; i <= 4; i++) {
              const stepElement = document.getElementById("step-" + i);
              stepElement.style.display = "none";
              stepElement.classList.remove("fade-out", "fade-in");
            }
            const targetStepElement = document.getElementById("step-" + step);
            targetStepElement.style.display = "";
            targetStepElement.classList.add("fade-in");
            for (let i = 1; i <= 4; i++) {
              setTimeout(() => {
                document
                  .getElementById("step-" + i + "-indicator")
                  .classList.toggle("active", i === step);
        }, i * 50);
            }
            setTimeout(() => {
              targetStepElement.classList.remove("fade-in");
            }, 600);
      }, 250);
        } else {
          for (let i = 1; i <= 4; i++) {
            document.getElementById("step-" + i).style.display =
              i === step ? "" : "none";
            document
              .getElementById("step-" + i + "-indicator")
              .classList.toggle("active", i === step);
          }
        }
      }

      const formEl = document.getElementById("regForm");
      formEl.addEventListener("submit", async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById("submitBtn");
        const successMessage = document.getElementById("success-message");
        submitBtn.disabled = true;
        const originalBtnText = submitBtn.innerHTML;
        submitBtn.innerHTML = "Submitting...";

        if (!validateBeforeSubmit()) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = originalBtnText;
          return;
        }

        const payload = collectAllFields();
        payload.submittedAt = new Date().toISOString();

        try {
          const res = await fetch(scriptURL, {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({ action: "register", ...payload }),
          });
          
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          
          const text = await res.text();
          console.log("Register response:", text);
          if (text.trim().toLowerCase() === "ok") {
            submitBtn.style.display = "none";
            successMessage.style.display = "block";
            successMessage.scrollIntoView({ behavior: "smooth" });
          } else {
            alert("Submission failed: " + text);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
          }
        } catch (err) {
          console.error("Backend submission error:", err);
          // Fallback via no-cors to avoid CORS edge failures (server must accept)
          try {
            const fallbackRes = await fetch(scriptURL, {
              method: "POST",
              mode: "no-cors",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({ action: "register", ...payload }),
            });
            // With no-cors we can't read body; assume success if no exception
            submitBtn.style.display = "none";
            successMessage.style.display = "block";
            successMessage.scrollIntoView({ behavior: "smooth" });
          } catch (fallbackErr) {
            alert("Network / server error: " + fallbackErr.message + ". Please try again.");
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
          }
        }
      });

      document.addEventListener("mousemove", function (e) {
        const particles = document.querySelectorAll(".particle");
        const mouseX = e.clientX / window.innerWidth;
        const mouseY = e.clientY / window.innerHeight;

        particles.forEach((particle, index) => {
          const speed = ((index % 3) + 1) * 0.5;
          const x = (mouseX - 0.5) * speed;
          const y = (mouseY - 0.5) * speed;

          particle.style.transform += ` translate(${x}px, ${y}px)`;
        });
      });

      const emailInput = document.getElementById("email");
      const sendOtpBtn = document.getElementById("sendOtpBtn");
      const otpSection = document.getElementById("otp-section");
      const nextBtn = document.getElementById("nextBtn");
      const otpInput = document.getElementById("otp");
      const passwordInput = document.getElementById("password");
      const confirmPasswordInput = document.getElementById("confirmPassword");
      const emailError = document.getElementById("email-error");
      const otpError = document.getElementById("otp-error");
      const passwordError = document.getElementById("password-error");

      let otpSent = false;
      let otpVerified = false;
      let mockOtp = "";

      function validateEmail(email) {
        return /^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email);
      }

      sendOtpBtn.onclick = async function () {
        const email = emailInput.value.trim();
        if (!validateEmail(email)) {
          emailError.style.display = "block";
          return;
        } else {
          emailError.style.display = "none";
        }

        try {
          const res = await fetch(scriptURL, {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
              action: "sendOtp",
              email,
            }),
          });
          
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          
          const text = await res.text();
          console.log("OTP Response:", text);
          if (text === "OTP sent") {
            otpSection.classList.remove("hidden");
            otpSent = true;
            alert("Here is your OTP for Early Birds access of Empresario (valid for 5 minutes).");
          } else {
            alert("Server response: " + text);
          }
        } catch (e) {
          console.error("OTP Error:", e);
          alert("Error sending OTP: " + e.message + ". Please try again.");
        }
        validateStep1();
      };

      function validateStep1() {
        let valid = true;
        if (!validateEmail(emailInput.value.trim()) || !otpSent) valid = false;
        if (otpSection && !otpSection.classList.contains("hidden")) {
          if (!/^[0-9]{6}$/.test(otpInput.value.trim())) {
            otpError.style.display = "block";
            valid = false;
          } else {
            otpError.style.display = "none";
          }
          if (
            !passwordInput.value ||
            !confirmPasswordInput.value ||
            passwordInput.value !== confirmPasswordInput.value
          ) {
            passwordError.style.display = "block";
            valid = false;
          } else {
            passwordError.style.display = "none";
          }
        }
        nextBtn.disabled = !valid;
      }

      emailInput.addEventListener("input", validateStep1);
      otpInput.addEventListener("input", validateStep1);
      passwordInput.addEventListener("input", validateStep1);
      confirmPasswordInput.addEventListener("input", validateStep1);

      nextBtn.onclick = async function () {
        if (nextBtn.disabled) return;

        const email = emailInput.value.trim();
        const otp = otpInput.value.trim();

        nextBtn.disabled = true;
        nextBtn.innerHTML = "Verifying...";

        try {
          const res = await fetch(scriptURL, {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({
              action: "verifyOtp",
              email,
              otp,
            }),
          });
          
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          
          const text = await res.text();
          if (text === "OTP valid") {
            otpVerified = true;
            // Advance to step 2 (removed early presave to keep verification token for final submit)
            try {
              const payload = collectAllFields();
              const PROGRESS_KEY = "empresarioRegProgress";
              localStorage.setItem(PROGRESS_KEY, JSON.stringify({ step: 2, data: payload }));
            } catch (_) {}
            setTimeout(() => {
              nextStep(2);
              nextBtn.innerHTML = "Next";
              nextBtn.disabled = false;
            }, 300);
          } else {
            otpError.style.display = "block";
            alert(text);
            nextBtn.innerHTML = "Next";
            nextBtn.disabled = false;
          }
        } catch (e) {
          alert("Error verifying OTP: " + e.message + ". Please try again.");
          nextBtn.innerHTML = "Next";
          nextBtn.disabled = false;
        }
      };

      // Progress persistence helpers
      const PROGRESS_KEY = "empresarioRegProgress";
      function getCurrentStepNumber() {
        for (let i = 1; i <= 4; i++) {
          const el = document.getElementById("step-" + i);
          if (el && el.style.display !== "none") return i;
        }
        return 1;
      }

      function saveProgress() {
        try {
          const data = collectAllFields();
          const step = getCurrentStepNumber();
          localStorage.setItem(PROGRESS_KEY, JSON.stringify({ step, data }));
        } catch (e) {
          console.warn("Save progress failed:", e);
        }
      }

      function loadProgress() {
        try {
          const raw = localStorage.getItem(PROGRESS_KEY);
          if (!raw) return;
          const saved = JSON.parse(raw);
          const data = saved?.data || {};
          // Step 1
          if (typeof data.email === "string") {
            const emailEl = document.getElementById("email");
            if (emailEl) emailEl.value = data.email;
          }
          // Step 2 inputs (order-based like collectAllFields)
          const step2Inputs = document.querySelectorAll("#step-2 input");
          if (step2Inputs[0]) step2Inputs[0].value = data.fullName || "";
          if (step2Inputs[1]) step2Inputs[1].value = data.personalEmail || "";
          if (step2Inputs[2]) step2Inputs[2].value = data.phone || "";
          if (step2Inputs[3]) step2Inputs[3].value = data.organization || "";
          if (step2Inputs[4]) step2Inputs[4].value = data.city || "";
          // Step 3
          const step3TextInputs = document.querySelectorAll("#step-3 input");
          const step3Selects = document.querySelectorAll("#step-3 select");
          if (step3TextInputs[0]) step3TextInputs[0].value = data.startupName || "";
          if (step3TextInputs[1]) step3TextInputs[1].value = data.website || "";
          if (step3Selects[0]) step3Selects[0].value = data.industry || "";
          if (step3Selects[1]) step3Selects[1].value = data.socialImpact || "";
          if (step3Selects[2]) step3Selects[2].value = data.iitkgpAffiliation || "";
          if (step3Selects[3]) step3Selects[3].value = data.aiMlCore || "";
          // TIS
          const tisInput = document.querySelector('#step-3 input[type="text"]:last-of-type');
          if (tisInput) tisInput.value = data.tis || "";
          // Step 4 textareas
          const step4Areas = document.querySelectorAll("#step-4 textarea");
          if (step4Areas[0]) step4Areas[0].value = data.problem || "";
          if (step4Areas[1]) step4Areas[1].value = data.solution || "";
          if (step4Areas[2]) step4Areas[2].value = data.market || "";
          if (step4Areas[3]) step4Areas[3].value = data.traction || "";
          if (step4Areas[4]) step4Areas[4].value = data.revenue || "";
          if (step4Areas[5]) step4Areas[5].value = data.extra || "";
          // Advance to saved step if > 1
          const savedStep = parseInt(saved?.step, 10);
          if (!isNaN(savedStep) && savedStep >= 2 && savedStep <= 4) {
            nextStep(savedStep);
            if (savedStep >= 2) otpVerified = true;
          }
        } catch (e) {
          console.warn("Load progress failed:", e);
        }
      }

      // Auto-save on input changes
      document
        .querySelectorAll('#regForm input, #regForm select, #regForm textarea')
        .forEach((el) => {
          el.addEventListener('input', saveProgress);
          el.addEventListener('change', saveProgress);
        });

      // Step-wise validation helpers
      function getRequiredFieldsInStep(stepNum) {
        return Array.from(
          document.querySelectorAll(
            `#step-${stepNum} input[required], #step-${stepNum} select[required], #step-${stepNum} textarea[required]`
          )
        );
      }

      function allRequiredFilledInStep(stepNum) {
        const fields = getRequiredFieldsInStep(stepNum);
        return fields.every((el) => el.checkValidity());
      }

      function goToFirstInvalidInStep(stepNum) {
        const fields = getRequiredFieldsInStep(stepNum);
        const firstInvalid = fields.find((el) => !el.checkValidity());
        if (firstInvalid) {
          nextStep(stepNum);
          setTimeout(() => {
            if (typeof firstInvalid.reportValidity === 'function') {
              firstInvalid.reportValidity();
            } else {
              firstInvalid.focus();
            }
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }, 300);
        }
      }

      function updateStep2NextState() {
        const btn = document.querySelector('#step-2 .next-btn');
        if (btn) btn.disabled = !allRequiredFilledInStep(2);
      }
      function updateStep3NextState() {
        const btn = document.querySelector('#step-3 .next-btn');
        if (btn) btn.disabled = !allRequiredFilledInStep(3);
      }

      // Attach dynamic enable/disable for Next buttons on Steps 2 and 3
      getRequiredFieldsInStep(2).forEach((el) => {
        el.addEventListener('input', updateStep2NextState);
        el.addEventListener('change', updateStep2NextState);
      });
      getRequiredFieldsInStep(3).forEach((el) => {
        el.addEventListener('input', updateStep3NextState);
        el.addEventListener('change', updateStep3NextState);
      });

      // Be lenient with website input by auto-prefixing protocol
      const websiteInput = document.querySelector('#step-3 input[type="url"]');
      if (websiteInput) {
        websiteInput.addEventListener('blur', () => {
          const val = websiteInput.value.trim();
          if (val && !/^https?:\/\//i.test(val)) {
            websiteInput.value = 'https://' + val;
          }
          updateStep3NextState();
        });
      }

      // Initialize button states
      updateStep2NextState();
      updateStep3NextState();

      function handleStep2Next() {
        const stepNum = 2;
        const nextButton = document.querySelector('#step-2 .next-btn');
        if (nextButton) nextButton.disabled = true;
        if (!allRequiredFilledInStep(stepNum)) {
          goToFirstInvalidInStep(stepNum);
          if (nextButton) nextButton.disabled = false;
          return;
        }
        saveProgress();
        nextStep(3);
        if (nextButton) nextButton.disabled = false;
      }

      function handleStep3Next() {
        const stepNum = 3;
        const nextButton = document.querySelector('#step-3 .next-btn');
        if (nextButton) nextButton.disabled = true;
        if (!allRequiredFilledInStep(stepNum)) {
          goToFirstInvalidInStep(stepNum);
          if (nextButton) nextButton.disabled = false;
          return;
        }
        saveProgress();
        nextStep(4);
        if (nextButton) nextButton.disabled = false;
      }

      function validateBeforeSubmit() {
        // Ensure OTP verified
        if (!otpVerified) {
          alert('Please verify your email via OTP before submitting.');
          nextStep(1);
          return false;
        }
        // Validate each step's required fields
        if (!allRequiredFilledInStep(2)) {
          goToFirstInvalidInStep(2);
          return false;
        }
        if (!allRequiredFilledInStep(3)) {
          goToFirstInvalidInStep(3);
          return false;
        }
        if (!allRequiredFilledInStep(4)) {
          goToFirstInvalidInStep(4);
          return false;
        }
        return true;
      }

      function collectAllFields() {
        const email = document.getElementById("email").value.trim();
  const password = (document.getElementById("password")?.value || "").trim();

        // Step 2 (in order)
        const step2Inputs = document.querySelectorAll("#step-2 input");
        const fullName = step2Inputs[0]?.value?.trim() || "";
        const personalEmail = step2Inputs[1]?.value?.trim() || "";
        const phone = step2Inputs[2]?.value?.trim() || "";
        const organization = step2Inputs[3]?.value?.trim() || "";
        const city = step2Inputs[4]?.value?.trim() || "";

        // Step 3 (inputs + selects in order)
        const step3TextInputs = document.querySelectorAll("#step-3 input");
        const step3Selects = document.querySelectorAll("#step-3 select");
        const startupName = step3TextInputs[0]?.value?.trim() || "";
        const website = step3TextInputs[1]?.value?.trim() || "";
        const industry = step3Selects[0]?.value || "";
        const socialImpact = step3Selects[1]?.value || "";
        const iitkgpAffiliation = step3Selects[2]?.value || "";
        const aiMlCore = step3Selects[3]?.value || "";
        const tis =
          document
            .querySelector('#step-3 input[type="text"]:last-of-type')
            ?.value?.trim() ||
          step3TextInputs[2]?.value?.trim() ||
          "";

        // Step 4 (textareas in order)
        const step4Areas = document.querySelectorAll("#step-4 textarea");
        const problem = step4Areas[0]?.value?.trim() || "";
        const solution = step4Areas[1]?.value?.trim() || "";
        const market = step4Areas[2]?.value?.trim() || "";
        const traction = step4Areas[3]?.value?.trim() || "";
        const revenue = step4Areas[4]?.value?.trim() || "";
        const extra = step4Areas[5]?.value?.trim() || "";

        return {
          email,
          password,
          fullName,
          personalEmail,
          phone,
          organization,
          city,
          startupName,
          website,
          industry,
          socialImpact,
          iitkgpAffiliation,
          aiMlCore,
          tis,
          problem,
          solution,
          market,
          traction,
          revenue,
          extra,
        };
      }

      // Attempt to restore progress on load
      loadProgress();
    </script>
  </body>
</html>
